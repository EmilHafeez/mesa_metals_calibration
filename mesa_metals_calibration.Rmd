---
title: "Metals in MESA Calibration Data Cleaning and Analysis Replication"
author: "Emil Hafeez, eh2928"
geometry: "left=2.57cm,right=2.57cm,top=2.57cm,bottom=2.57cm"
output:
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 3
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lipsum}
- \pagestyle{fancy}
- \fancyhead[R]{\thepage}
- \fancypagestyle{plain}{\pagestyle{fancy}}
--- 

# Section 1: Setup

```{r, include = F}
library(tidyverse)
library(readxl)
library(modelr)
library(openxlsx)
```

```{r, include = F}
set.seed(1107)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
knitr::opts_chunk$set(echo = TRUE)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
```

```{r}
#read in, make csv for safekeeping and easier downstream editing
arsenic_As_xl = read_excel(
  "./data/Calibration_check_MESA_04012021.xlsx", 
  sheet = "arsenic_As ",
  range = "A2:E38") %>% 
  janitor::clean_names() %>% 
  mutate(date = as.Date(as.POSIXct(date)))
```

# Section 2: Testing how they got their regression results

It seems like Rony is saying that Kathrin's approach in the Excel sheet isn't precisely the way that their program does it, and that to replicate their results might need the manipulations that Rony describes (and seems to use the last sheet from the Excel). However these manipulations seem to appear in the Excel sheet (BLK corrected column name) and do not create the regression results in the Excel.

```{r}
arsenic_As_xl_tester = 
  arsenic_As_xl %>% 
  filter(date == "2020-01-08" & no_cal == 1)

glm_fit = glm(as_o_blk_corrected ~ std_conc_ppb, 
    data = arsenic_As_xl_tester,
    family = gaussian(link = "identity")) 

summary(glm_fit)
```
```{r try again}
#Rony's email describes the following manipulation conducted by their program: take the aso_cps and divide it by the std_conc_ppb, then subtract off the first aso_cps aka the blank signal. This does not replicate what is in the Excel. Using the blank-corrected values from the excl does not either.
# arsenic_As_xl_tester_3 =
#   arsenic_As_xl %>%
#   filter(date == "2020-01-08" & no_cal == 1) %>%
#   mutate(
#     zeroer = ((as_o_cps/std_conc_ppb))
#   ) 
# 
# glm_fit = glm(zeroer ~ std_conc_ppb,
#     data = arsenic_As_xl_tester_3,
#     family = gaussian(link = "identity"))
# 
# summary(glm_fit)
```

# Section 3a: Moving into Iteration
Let's iterate for one element.

```{r}
arsenic_results_df =
  arsenic_As_xl %>%
  nest(data = c(std_conc_ppb, as_o_cps, as_o_blk_corrected)) %>%
  mutate(
    models =
      map(.x = data, ~glm(as_o_blk_corrected ~ std_conc_ppb, data = .x,
                     family = gaussian(link = "identity"))),
    results = map(models, broom::tidy)
  ) %>%
  select(date, no_cal, results) %>%
  unnest(results)
```

# Section 3b: All Element Iteration
Now let's work on iterating for all elements (organized by Excel sheet).
```{r}
path =
  "./data/Calibration_check_MESA_04012021.xlsx"

mesa_metals_list = path %>%
  excel_sheets() %>%
  set_names() %>%
  map(read_excel, path = path, range = "A2:E38", col_names = c("date","no_cal","std_conc_ppb","cps","cps_blk_corrected"))
#don't need the first and last sheet, "General" and "Distribution_sample_std"
mesa_metals_list = 
  mesa_metals_list[-c(1,19)]
```

Quick cleanup.
```{r}
rm(arsenic_results_df, glm_fit)
```

Now to iterate the regressions for each of the (date,no_cal) groups within each element.
```{r}
mesa_metals_df = as_tibble(matrix(mesa_metals_list)) %>% rename(elements_data = V1)

mesa_metals_df = 
  mesa_metals_df %>% 
  add_column(elements = c("cobalt_Co", "nickel_Ni", "zinc_Zn", "copper_Cu", "strontium_Sr", "molybdenum_Mo", "antimony_Sb", "cesium_Cs", "barium_Ba", "tungsten_W", "thallium_Tl", "lead_Pb", "uranium_U", "manganese_Mn", "selenium_Se", "arsenic_As", "cadmium_Cd")) %>% 
  select(elements, everything())




mesa_metals_df =
  mesa_metals_df %>%
  unnest(elements_data,
         ptype =
           tibble(bar =
                    tibble(..1$date = character(), ..6$date = character())))

```



#Section 4 WIP Clutter
Some columns only have 37 rows of data, and I selected 38 to catch all of it. Therefore there are entirely blank rows in the list-column's nested data. The below does not remove it, obviously; ignorable for now but must troubleshoot
```{r}
#this cleaning must be revisited, listcolumn/tibble troubles
# mesa_metals_df = mesa_metals_df[rowSums(is.na(mesa_metals_df)) != ncol(mesa_metals_df),]
```














