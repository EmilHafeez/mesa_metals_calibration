---
title: "MESA Metals: Examining Variability within Calibration Curves"
author: ""
geometry: "left=2.57cm,right=2.57cm,top=2.57cm,bottom=2.57cm"
output:
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 3
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lipsum}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \pagestyle{fancy}
- \fancyhead[R]{\thepage}
- \fancypagestyle{plain}{\pagestyle{fancy}}
--- 

\newpage

# Section 1: Setup

NB a lot of the code is hidden in the PDF; investigating via visualization here.
 
```{r, include = F}
library(tidyverse)
library(readxl)
library(modelr)
library(openxlsx)
```

```{r, include = F}
set.seed(1107)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
knitr::opts_chunk$set(echo = TRUE)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  ggplot2.discrete.colour = "viridis",
  ggplot2.discrete.fill = "viridis"
)

knitr::opts_chunk$set(fig.align="center")

```

# Section 2: Arsenic Case Study, Regression Results Replication Attempt

This section reads in just one date's one calibration iteration number, for arsenic only. Then, we can fit a regression to this (the blank corrected concentrations regressed on the standard concentrations).

```{r, include = F}
#read in, basic tidy
arsenic_As_df = read_excel(
  "./data/Calibration_check_MESA_04012021.xlsx", 
  sheet = "arsenic_As ",
  range = "A1:E38") %>% 
  janitor::clean_names() %>% 
  mutate(date = as.Date(as.POSIXct(date))) %>% 
  filter(!is.na(date))
```

```{r, include = F}
arsenic_As_test = 
  arsenic_As_df %>% 
  filter(date == "2020-01-08" & no_cal == 1)

glm_fit = glm(as_o_blk_corrected ~ std_conc_ppb, 
    data = arsenic_As_test,
    family = gaussian(link = "identity")) 
```

Printing this regression output,

```{r}
summary(glm_fit)
```

We can see this is not a precise replication of the first arsenic regression. This is close to the Excel sheet results but not sufficient; arsenic's 1/8/20 Calibration 1 has intercept and beta estimates of about -179.92 and 6887.72 but these show have about -124.99 and 6871.96. 

I am not able to replicate the Excel result by trying different tuning approaches (is there a weight being implemented, maybe from the last sheet?). Additionally, this is not the same regression as the spectroscopy program uses at all, as per Rony's 4/1/21 email. This must be revisited and scaled across the document, but works to start looking at the patterns.

# Section 3: Iterate Regression for All Arsenic

Let's iterate for each date and calibration number, for one element.
```{r, include = F}
arsenic_results_df =
  arsenic_As_df %>%
  filter(!is.na(date)) %>% 
  nest(data = c(std_conc_ppb, as_o_cps, as_o_blk_corrected)) %>%
  mutate(
    models =
      map(.x = data, ~glm(as_o_blk_corrected ~ std_conc_ppb, data = .x,
                     family = gaussian(link = "identity"))),
    results = map(models, broom::tidy)
  ) %>%
  select(date, no_cal, results) %>%
  unnest(results)
```

# Section 4: Plot Arsenic Regression Lines and Intercept vs Slope

Then we look at these regression lines. Each unique combination of date and calibration number are their own regression line, as in the Excel.

```{r, echo = F}
arsenic_As_df %>% 
  mutate(date = as.factor(date)) %>% 
ggplot(
  aes(
    x = std_conc_ppb, 
    y = as_o_blk_corrected, 
    group = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three"))), 
    color = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three"))),
    shape = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three"))))
  ) +
  stat_smooth(method = "lm", formula = y ~ x, se = F, size = .75) + 
  geom_point(size = 3) + 
  scale_y_continuous(breaks = seq(0, 50000, 10000)) +
    labs(color = "Regressions per \nDate.CalibrationNumber",
         shape = "Regressions per \nDate.CalibrationNumber",
         title = "Regressing Corrected Blank Concentration on Standard Concentration", 
         caption = "Examining the variability of arsenic as a case study") +
    scale_shape_manual(values=seq(0,9))
```
Focusing on these regression lines, let's take a look at the intercepts against the slopes. 
```{r, echo = F}
arsenic_results_df %>% 
  select(date, no_cal, term, estimate) %>% 
  pivot_wider(
    names_from = "term",
    values_from = c("estimate")) %>% 
  rename(intercept = c("(Intercept)")) %>% 
  rename(beta_hat = c("std_conc_ppb")) %>% 
  mutate(date = as.factor(date)) %>% 
ggplot(
  aes(
    x = intercept, 
    y = beta_hat, 
    group = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three"))), 
    color = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three"))),
    shape = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three"))))
  ) +
  geom_point(size = 3) + 
  scale_x_continuous(breaks = seq(-250, 50, 25)) +
  scale_y_continuous(breaks = seq(0, 15000, 1000)) +
    labs(color = "Regressions per \nDate.CalibrationNumber",
         shape = "Regressions per \nDate.CalibrationNumber",
         title = "Visualizing Intercepts vs Slopes", 
         caption = "Examining the variability of arsenic as a case study") +
    scale_shape_manual(values=seq(0,9))
```

# Section 5: All Elements Data Manipulation

Great. Now let's work on iterating for all elements (organized per Excel sheets within the workbook).

I read in the data.
```{r, include = F}
path =
  "./data/Calibration_check_MESA_04012021.xlsx"

mesa_metals_list = path %>%
  excel_sheets() %>%
  set_names() %>%
  map(read_excel, 
      path = path, 
      range = "A2:E38", 
      col_names = c("date","no_cal","std_conc_ppb","cps","cps_blk_corrected"))

#don't need the first and last sheet, "General" and "Distribution_sample_std"
mesa_metals_list = 
  mesa_metals_list[-c(1,19)]
```

Then, iterate the regressions for each of the (date,no_cal) groups within each element.
```{r, include = F}
mesa_metals_df = as_tibble(matrix(mesa_metals_list)) %>% 
  rename(elements_data = V1)

mesa_metals_df = 
  mesa_metals_df %>% 
  add_column(elements = c("cobalt_Co", "nickel_Ni", "zinc_Zn", "copper_Cu", "strontium_Sr", "molybdenum_Mo", "antimony_Sb", "cesium_Cs", "barium_Ba", "tungsten_W", "thallium_Tl", "lead_Pb", "uranium_U", "manganese_Mn", "selenium_Se", "arsenic_As", "cadmium_Cd")) %>% 
  select(elements, everything())

mesa_metals_df =
  mesa_metals_df %>%
  unnest(cols = elements_data) %>% 
  filter(!is.na(date))
```


# Section 6: Plot All Elements Regression Lines and Intercept vs Slope

Then, we're in a position to visualize the regression lines, and add the raw data to the plot just to see:

\pagestyle{fancy}
\fancyhf{}
\newpage
\paperwidth=\pdfpageheight
\paperheight=\pdfpagewidth
\pdfpageheight=\paperheight
\pdfpagewidth=\paperwidth
\headwidth=\textheight
\begingroup 
\vsize=\textwidth
\hsize=\textheight

```{r, message = F, warning = F, echo = F, fig.width= 25.37, fig.height = 19.02}
mesa_metals_df %>% 
  mutate(date = as.factor(date)) %>% 
ggplot(
  aes(
    x = std_conc_ppb, 
    y = cps_blk_corrected, 
    group = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three", "Cal_Four", "Cal_Five", "Cal_Six"))), 
    color = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three", "Cal_Four", "Cal_Five", "Cal_Six"))),
    shape = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three", "Cal_Four", "Cal_Five", "Cal_Six"))),
  )) +
  stat_smooth(method = "lm", formula = y ~ x, se = F, size = .75) +
  geom_point() + 
    labs(color = "Regressions per \nDate.CalibrationNumber",
         shape = "Regressions per \nDate.CalibrationNumber",
         title = "Regressing Corrected Blank Concentration on Standard Concentration", 
         subtitle = "Faceted by Elements", 
         caption = "Examining the variability between regression lines, by element, per date:calibration group") +
  facet_wrap(~elements, scales = "free") +
    scale_shape_manual(values=seq(0,9)) + 
  theme_bw(base_size = 30)
```

Interesting. There is some substantial variability between estimates within each element. Will think more on this. Note that thallium_Tl has a high value that is visible in the raw data (Excel too). 

Like we did for arsenic, let's look at the intercepts vs slopes for these regression lines, per element also. Note cobalt's additional calibration numbers.

```{r, warning = F, message = F, include = F}
#make the results df
mesa_metals_results_df = 
  mesa_metals_df %>% 
  filter(!is.na(date)) %>% 
  nest(data = c(std_conc_ppb, cps, cps_blk_corrected)) %>%
  mutate(
    models =
      map(.x = data, ~glm(cps_blk_corrected ~ std_conc_ppb, data = .x,
                     family = gaussian(link = "identity"))),
    results = map(models, broom::tidy)
  ) %>%
  select(elements, date, no_cal, results) %>%
  unnest(results)
```

```{r, echo = F, message = F, warning = F, fig.fullwidth=TRUE}
#plot it
mesa_metals_results_df %>% 
  select(elements, date, no_cal, term, estimate) %>% 
  pivot_wider(
    names_from = "term",
    values_from = c("estimate")) %>% 
  rename(intercept = c("(Intercept)")) %>% 
  rename(beta_hat = c("std_conc_ppb")) %>% 
  mutate(date = as.factor(date)) %>% 
ggplot(
  aes(
    x = intercept, 
    y = beta_hat, 
    group = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three", "Cal_Four", "Cal_Five", "Cal_Six"))), 
    color = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three", "Cal_Four", "Cal_Five", "Cal_Six"))),
    shape = interaction(date,factor(no_cal, labels = c("Cal_One", "Cal_Two", "Cal_Three", "Cal_Four", "Cal_Five", "Cal_Six")))
    )
  ) +
  geom_point(size = 3) + 
    labs(color = "Regressions per \nDate.CalibrationNumber",
         shape = "Regressions per \nDate.CalibrationNumber",
         title = "Visualizing intercepts vs slopes", 
         subtitle = "Faceted by elements", 
         caption = "Examining the variability of intercepts vs slopes, by element, per date:calibration group") +
  facet_wrap(~elements, scales = "free") +
    scale_shape_manual(values=seq(15,23)) + 
  theme_bw(base_size = 8)
```

\endgroup
\newpage
\paperwidth=\pdfpageheight
\paperheight=\pdfpagewidth
\pdfpageheight=\paperheight
\pdfpagewidth=\paperwidth
\headwidth=\textwidth